name: CD - Build and Deploy

on:
  push:
    branches: [main]

env:
  GKE_PROJECT: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}

  # Artifact Registry (replaces deprecated GCR)
  REGISTRY: us-central1-docker.pkg.dev
  AR_REPO: energy-repo

  HELM_RELEASE_NAME: energy-pipeline
  HELM_NAMESPACE: energy-pipeline

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Uncomment when GCP Workload Identity Federation is configured
      # - name: Authenticate to Google Cloud
      #   id: auth
      #   uses: google-github-actions/auth@v2
      #   with:
      #     workload_identity_provider: "projects/${{ env.GKE_PROJECT }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
      #     service_account: "github-actions@${{ env.GKE_PROJECT }}.iam.gserviceaccount.com"

      # - name: Configure Docker for Artifact Registry
      #   run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Ingestion API
        uses: docker/build-push-action@v6
        with:
          context: ./ingestion-api
          push: false  # Set to true when Artifact Registry is configured
          tags: |
            ${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/${{ env.AR_REPO }}/ingestion-api:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/${{ env.AR_REPO }}/ingestion-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Processing Service
        uses: docker/build-push-action@v6
        with:
          context: ./processing-service
          push: false  # Set to true when Artifact Registry is configured
          tags: |
            ${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/${{ env.AR_REPO }}/processing-service:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/${{ env.AR_REPO }}/processing-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Uncomment when GCP Workload Identity Federation is configured
      # - name: Authenticate to Google Cloud
      #   id: auth
      #   uses: google-github-actions/auth@v2
      #   with:
      #     workload_identity_provider: "projects/${{ env.GKE_PROJECT }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
      #     service_account: "github-actions@${{ env.GKE_PROJECT }}.iam.gserviceaccount.com"

      # - name: Get GKE Credentials
      #   uses: google-github-actions/get-gke-credentials@v2
      #   with:
      #     cluster_name: ${{ env.GKE_CLUSTER }}
      #     location: ${{ env.GKE_ZONE }}

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Add Bitnami Helm Repository
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Update Helm Dependencies
        run: helm dependency update charts/energy-pipeline

      # Uncomment when GKE is configured
      # - name: Deploy to GKE
      #   run: |
      #     helm upgrade --install ${{ env.HELM_RELEASE_NAME }} ./charts/energy-pipeline \
      #       --namespace ${{ env.HELM_NAMESPACE }} \
      #       --create-namespace \
      #       --set ingestionApi.image.repository=${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/${{ env.AR_REPO }}/ingestion-api \
      #       --set ingestionApi.image.tag=${{ github.sha }} \
      #       --set processingService.image.repository=${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/${{ env.AR_REPO }}/processing-service \
      #       --set processingService.image.tag=${{ github.sha }} \
      #       --wait \
      #       --timeout 5m

      - name: Helm Lint
        run: helm lint ./charts/energy-pipeline

      - name: Helm Template (Dry Run)
        run: |
          helm template ${{ env.HELM_RELEASE_NAME }} ./charts/energy-pipeline \
            --namespace ${{ env.HELM_NAMESPACE }}
