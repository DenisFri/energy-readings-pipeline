name: CD - Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  # GKE Configuration - Update these values
  GKE_PROJECT: ${{ secrets.GKE_PROJECT }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}

  # Container Registry
  REGISTRY: gcr.io

  # Helm Release
  HELM_RELEASE_NAME: energy-pipeline
  HELM_NAMESPACE: energy-pipeline

jobs:
  build:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    outputs:
      ingestion_image: ${{ steps.build-ingestion.outputs.image }}
      processing_image: ${{ steps.build-processing.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # PLACEHOLDER: Configure GCP OIDC Authentication
      # Uncomment and configure for your GCP project
      # - name: Authenticate to Google Cloud
      #   id: auth
      #   uses: google-github-actions/auth@v2
      #   with:
      #     workload_identity_provider: 'projects/${{ env.GKE_PROJECT }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
      #     service_account: 'github-actions@${{ env.GKE_PROJECT }}.iam.gserviceaccount.com'

      # PLACEHOLDER: Configure Docker for GCR
      # - name: Configure Docker for GCR
      #   run: gcloud auth configure-docker gcr.io --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Ingestion API Image
        id: build-ingestion
        uses: docker/build-push-action@v5
        with:
          context: ./ingestion-api
          push: false  # Set to true when GCR is configured
          tags: |
            ${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/ingestion-api:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/ingestion-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Processing Service Image
        id: build-processing
        uses: docker/build-push-action@v5
        with:
          context: ./processing-service
          push: false  # Set to true when GCR is configured
          tags: |
            ${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/processing-service:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/processing-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # PLACEHOLDER: Configure GCP OIDC Authentication
      # Uncomment and configure for your GCP project
      # - name: Authenticate to Google Cloud
      #   id: auth
      #   uses: google-github-actions/auth@v2
      #   with:
      #     workload_identity_provider: 'projects/${{ env.GKE_PROJECT }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
      #     service_account: 'github-actions@${{ env.GKE_PROJECT }}.iam.gserviceaccount.com'

      # PLACEHOLDER: Get GKE Credentials
      # - name: Get GKE Credentials
      #   uses: google-github-actions/get-gke-credentials@v2
      #   with:
      #     cluster_name: ${{ env.GKE_CLUSTER }}
      #     location: ${{ env.GKE_ZONE }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Add Bitnami Helm Repository
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Update Helm Dependencies
        run: |
          cd charts/energy-pipeline
          helm dependency update

      # PLACEHOLDER: Deploy with Helm
      # Uncomment when GKE is configured
      # - name: Deploy to GKE
      #   run: |
      #     helm upgrade --install ${{ env.HELM_RELEASE_NAME }} ./charts/energy-pipeline \
      #       --namespace ${{ env.HELM_NAMESPACE }} \
      #       --create-namespace \
      #       --set ingestionApi.image.repository=${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/ingestion-api \
      #       --set ingestionApi.image.tag=${{ github.sha }} \
      #       --set processingService.image.repository=${{ env.REGISTRY }}/${{ env.GKE_PROJECT }}/processing-service \
      #       --set processingService.image.tag=${{ github.sha }} \
      #       --wait \
      #       --timeout 5m

      - name: Helm Lint
        run: helm lint ./charts/energy-pipeline

      - name: Helm Template (Dry Run)
        run: |
          helm template ${{ env.HELM_RELEASE_NAME }} ./charts/energy-pipeline \
            --namespace ${{ env.HELM_NAMESPACE }}
